# Overview

This document describes a proxy service that can be used to access VM's VNC
using a time limited token.

## Motivation

An administrator may want to give VNC access to a client application without giving it permissions to access
or change resources in the cluster.

A VNC client could connect to this proxy service and use a temporary token to access only VNC on a specific VM.

## Goals

- A temporary token can be created to access VNC.
- It can only be used with one specific VM.
- It is valid only for a specific duration.

## User Stories

- A VM owner wants to give access to VNC to a third party application without giving it permissions to modify the VM 
definition in the cluster.

# Design

The proxy service exposes API to create the token and to access VNC.

The token is time limited JWT, which contains the name, namespace, and UUID of the VM. For example:

```json
{
  "nm": "my-vm",
  "nmspc": "my-namespace",
  "uid": "2ed1f9d2-62e5-45d7-91bd-0b52bf2743ad"
}
```

Only users that have RBAC permissions to access `/vnc` subresource on `VMI` can create tokens.

To access the VNC, the proxy could connect directly to the `virt-handler`.

## API Examples

### Getting the VNC token
```
GET /${VM_NAMESPACE}/${VM_NAME}/token
```

Parameters:
- `duration` - Time duration while the token is valid.

Headers:
- `Authorization` - The bearer token is used to check RBAC access to `/vnc` subresource on `VMI`.

Response definition:
```go
type TokenResponse struct {
	Token string `json:"token"`
	ExpirationTimestamp metav1.Time `json:"expirationTimestamp"`
}
```

### Accessing VNC using the token
```
GET /${VM_NAMESPACE}/${VM_NAME}/vnc
```

Headers:
- `Authorization` - The bearer token that was generated by `/token` endpoint.


## Functional Testing Approach

These cases should be tested:
- Token can be created.
- Token can be used to access VMI using VNC.
- Token expires after a set time.
- Token cannot be used to access VNC for a different VMI.
